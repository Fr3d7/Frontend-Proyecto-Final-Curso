pipeline {
  agent any
  options {
    skipDefaultCheckout(true)
    ansiColor('xterm')
    timestamps()
  }

  parameters {
    choice(name: 'TARGET_BRANCH', choices: ['DEV','QA','PROD'], description: 'Solo para jobs NO multibranch.')
  }

  environment {
    RAW_BRANCH  = ""
    PIPE_BRANCH = ""
    PROJECT_KEY = "frontend-proyecto-final-"

    SCANNER_HOME = tool 'sonar-scanner-win'
    REPO_URL     = "https://github.com/Fr3d7/Frontend-Proyecto-Final-Curso.git"
    APP_DIR      = "login-registration"
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Proyecto:  | Rama destino: "
        checkout([$class: 'GitSCM',
          branches: [[name: "*/"]],
          userRemoteConfigs: [[url: "", credentialsId: 'github-creds']]
        ])
        bat 'if not exist %APP_DIR% (echo ERROR: falta %APP_DIR% && dir /b && exit /b 1)'
      }
    }

    stage('Install dependencies') {
      steps {
        dir("") {
          bat '''
            chcp 65001 >NUL
            npm ci || npm install
          '''
        }
      }
    }

    stage('Build app') {
      steps {
        dir("") {
          withEnv(['CI=false']) {
            bat '''
              chcp 65001 >NUL
              npm run build
            '''
          }
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        dir("") {
          withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
            withSonarQubeEnv('sonar-local') {
              bat '''
                chcp 65001 >NUL
                
                echo === EJECUTANDO TESTS CON COBERTURA ===
                npm run test:ci
                
                echo === VERIFICANDO LCOV GENERADO ===
                if not exist coverage\\lcov.info (
                  echo ERROR CRITICO: coverage\\lcov.info NO EXISTE
                  dir /s /b coverage 2>nul || echo La carpeta coverage no existe
                  exit /b 1
                )
                for %%I in (coverage\\lcov.info) do @(
                  echo LCOV bytes: %%~zI
                  if "%%~zI"=="0" (
                    echo ERROR CRITICO: coverage\\lcov.info tiene 0 bytes - los tests no generaron cobertura
                    exit /b 1
                  )
                  echo Ruta absoluta: %%~fI
                )
                
                echo === EJECUTANDO SONAR SCANNER ===
                echo Usando sonar-project.properties para configuracion
                "%SCANNER_HOME%\\bin\\sonar-scanner.bat" ^
                  -Dproject.settings=sonar-project.properties ^
                  -Dsonar.projectVersion=%BUILD_NUMBER% ^
                  -Dsonar.token=%SONAR_TOKEN%
                
                echo === SONAR SCANNER COMPLETADO ===
              '''
            }
          }
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 10, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Package artifact') {
      steps {
        archiveArtifacts artifacts: "/build/**", fingerprint: true
        archiveArtifacts artifacts: "/coverage/**", allowEmptyArchive: true
      }
    }

    stage('Deploy') {
      when { expression { env.PIPE_BRANCH == 'QA' || env.PIPE_BRANCH == 'PROD' } }
      steps {
        script {
          def deployPath = (env.PIPE_BRANCH == 'PROD') ? 'C:\\deploy\\frontend' : 'C:\\deploy\\frontend-qa'
          bat "if not exist \"\" mkdir \"\""
          bat "xcopy /E /I /Y \"\\\\build\" \"\""
          echo "Desplegado a "
        }
      }
    }
  }

  post {
    always {
      echo "Fin | Rama:  | Build: #"
    }
  }
}